# Review Section - ê¸°ëŠ¥ ëª…ì„¸

## Props ì¸í„°í˜ì´ìŠ¤

```typescript
interface Review {
  id: string;
  author: string;
  rating: number;
  date: string;
  content: string;
  improvements?: string;
  helpful: number;
  userId?: string;  // ì‘ì„±ì ID (ì¶”í›„ ì¶”ê°€)
  avatar?: string;  // ì‘ì„±ì ì•„ë°”íƒ€ (ì¶”í›„ ì¶”ê°€)
}

interface ReviewSectionProps {
  performanceId: string;
  onReviewSubmit?: (review: Review) => void;  // ë¦¬ë·° ì œì¶œ ì½œë°±
  showForm?: boolean;  // ë¦¬ë·° ì‘ì„± í¼ í‘œì‹œ ì—¬ë¶€ (ê¸°ë³¸: true)
}
```

## í˜„ì¬ êµ¬í˜„ ìƒíƒœ âœ…

### 1. ë¦¬ë·° í‘œì‹œ
- ë¦¬ë·° ëª©ë¡ ë Œë”ë§
- Avatar, ì‘ì„±ì, ë‚ ì§œ, í‰ì  í‘œì‹œ
- ë¦¬ë·° ë‚´ìš© ë° ê°œì„ ì‚¬í•­ í‘œì‹œ
- "ë„ì›€ë¨" ë²„íŠ¼ í‘œì‹œ

### 2. ë¦¬ë·° ì‘ì„± í¼
- í‰ì  ì„ íƒ (1-5ì )
- ë¦¬ë·° í…ìŠ¤íŠ¸ ì…ë ¥
- ê°œì„ ì‚¬í•­ ì…ë ¥ (ì„ íƒ)
- ì œì¶œ ë²„íŠ¼

### 3. Mock ë°ì´í„°
- í•˜ë“œì½”ë”©ëœ ë¦¬ë·° 2ê°œ
- Form ì œì¶œ ì‹œ alert í‘œì‹œ (ì‹¤ì œ ì €ì¥ X)

## ê°œì„ ì´ í•„ìš”í•œ ê¸°ëŠ¥ ğŸ”§

### 1. API ì—°ë™ â­
**í˜„ì¬:** Mock ë°ì´í„° ë° alert  
**í•„ìš”í•œ ê¸°ëŠ¥:**
```typescript
// lib/api/reviews.ts
export const reviewApi = {
  async getByPerformanceId(performanceId: string) {
    if (USE_MOCK_MODE) {
      const reviews = getFromStorage<Review[]>(STORAGE_KEYS.REVIEWS, []);
      return { reviews: reviews.filter(r => r.performanceId === performanceId) };
    }
    return await apiCall(`/reviews/${performanceId}`);
  },

  async create(reviewData: {
    performanceId: string;
    rating: number;
    content: string;
    improvements?: string;
  }) {
    if (USE_MOCK_MODE) {
      const currentUser = getFromStorage(STORAGE_KEYS.CURRENT_USER, null);
      if (!currentUser) {
        throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      }

      const reviews = getFromStorage<Review[]>(STORAGE_KEYS.REVIEWS, []);
      const newReview = {
        id: `review_${Date.now()}`,
        ...reviewData,
        author: currentUser.name,
        userId: currentUser.id,
        date: new Date().toISOString(),
        helpful: 0,
      };
      
      reviews.push(newReview);
      setToStorage(STORAGE_KEYS.REVIEWS, reviews);
      return { review: newReview };
    }

    return await apiCall('/reviews', {
      method: 'POST',
      body: JSON.stringify(reviewData),
    }, true);
  },
};
```

### 2. "ë„ì›€ë¨" ê¸°ëŠ¥ â­
**í•„ìš”í•œ ê¸°ëŠ¥:**
```typescript
interface ReviewSectionProps {
  performanceId: string;
  onHelpful?: (reviewId: string) => void;
  isLoggedIn?: boolean;
}

const handleHelpful = async (reviewId: string) => {
  if (!isLoggedIn) {
    toast.error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  try {
    await reviewApi.toggleHelpful(reviewId);
    // ë¦¬ë·° ëª©ë¡ ì—…ë°ì´íŠ¸
    setReviews(prev => prev.map(r => 
      r.id === reviewId 
        ? { ...r, helpful: r.helpful + 1, isHelpful: true }
        : r
    ));
  } catch (error) {
    handleError(error);
  }
};
```

### 3. ë¦¬ë·° ìˆ˜ì •/ì‚­ì œ
**í•„ìš”í•œ ê¸°ëŠ¥:**
- ë³¸ì¸ì´ ì‘ì„±í•œ ë¦¬ë·°ë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
- ìˆ˜ì • ë²„íŠ¼ í´ë¦­ â†’ í¼ì— ê¸°ì¡´ ë‚´ìš© ë¡œë“œ
- ì‚­ì œ ë²„íŠ¼ í´ë¦­ â†’ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸

### 4. ë¦¬ë·° ì •ë ¬/í•„í„°ë§
**í•„ìš”í•œ ê¸°ëŠ¥:**
```typescript
// ì •ë ¬ ì˜µì…˜
type SortOption = 'recent' | 'helpful' | 'rating-high' | 'rating-low';

const [sortOption, setSortOption] = useState<SortOption>('recent');

const sortedReviews = useMemo(() => {
  const sorted = [...reviews];
  switch (sortOption) {
    case 'recent':
      return sorted.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
    case 'helpful':
      return sorted.sort((a, b) => b.helpful - a.helpful);
    case 'rating-high':
      return sorted.sort((a, b) => b.rating - a.rating);
    case 'rating-low':
      return sorted.sort((a, b) => a.rating - b.rating);
    default:
      return sorted;
  }
}, [reviews, sortOption]);
```

### 5. ë¦¬ë·° ì´ë¯¸ì§€ ì—…ë¡œë“œ
**í•„ìš”í•œ ê¸°ëŠ¥:**
- ë¦¬ë·°ì— ì‚¬ì§„ ì²¨ë¶€ (ìµœëŒ€ 3ì¥)
- Supabase Storageì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
- ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ í‘œì‹œ

### 6. ë¦¬ë·° ì‹ ê³  ê¸°ëŠ¥
**í•„ìš”í•œ ê¸°ëŠ¥:**
- ë¶€ì ì ˆí•œ ë¦¬ë·° ì‹ ê³ 
- ì‹ ê³  ë²„íŠ¼ (ë”ë³´ê¸° ë©”ë‰´)

### 7. í‰ê·  í‰ì  í‘œì‹œ
**í•„ìš”í•œ ê¸°ëŠ¥:**
```typescript
const averageRating = useMemo(() => {
  if (reviews.length === 0) return 0;
  const sum = reviews.reduce((acc, r) => acc + r.rating, 0);
  return (sum / reviews.length).toFixed(1);
}, [reviews]);
```

## API ì—°ë™ ê³„íš

### Supabase í…Œì´ë¸” ì„¤ê³„
```sql
CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  performance_id UUID REFERENCES performances(id),
  user_id UUID REFERENCES users(id),
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  content TEXT NOT NULL,
  improvements TEXT,
  helpful_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE review_helpful (
  user_id UUID REFERENCES users(id),
  review_id UUID REFERENCES reviews(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (user_id, review_id)
);

CREATE TABLE review_images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  review_id UUID REFERENCES reviews(id),
  image_url TEXT NOT NULL,
  order_index INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API ì—”ë“œí¬ì¸íŠ¸
- `GET /reviews/:performanceId` - ë¦¬ë·° ëª©ë¡ ì¡°íšŒ
- `POST /reviews` - ë¦¬ë·° ì‘ì„±
- `PUT /reviews/:id` - ë¦¬ë·° ìˆ˜ì •
- `DELETE /reviews/:id` - ë¦¬ë·° ì‚­ì œ
- `POST /reviews/:id/helpful` - ë„ì›€ë¨ í† ê¸€
- `POST /reviews/:id/report` - ë¦¬ë·° ì‹ ê³ 

## í…ŒìŠ¤íŠ¸ ê³„íš

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- í‰ì  ì„ íƒ í…ŒìŠ¤íŠ¸
- í¼ ìœ íš¨ì„± ê²€ì‚¬ í…ŒìŠ¤íŠ¸
- ë¦¬ë·° ëª©ë¡ ë Œë”ë§ í…ŒìŠ¤íŠ¸

### í†µí•© í…ŒìŠ¤íŠ¸
- API í˜¸ì¶œ í…ŒìŠ¤íŠ¸
- ë¦¬ë·° ì‘ì„± â†’ ëª©ë¡ ì—…ë°ì´íŠ¸ í”Œë¡œìš°
- ë„ì›€ë¨ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

### E2E í…ŒìŠ¤íŠ¸
- ë¦¬ë·° ì‘ì„± ì „ì²´ í”Œë¡œìš°
- ë¦¬ë·° ìˆ˜ì •/ì‚­ì œ í”Œë¡œìš°

## ì ‘ê·¼ì„± (a11y)

### ARIA ë ˆì´ë¸”
```tsx
<button
  aria-label={`${star}ì  í‰ê°€`}
  onClick={() => setRating(star)}
>
  <Star />
</button>

<Textarea
  aria-label="ë¦¬ë·° ë‚´ìš©"
  placeholder="ê³µì—°ì— ëŒ€í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”"
/>
```

### í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
- Tabìœ¼ë¡œ í‰ì  ë²„íŠ¼ ì´ë™
- Enter/Spaceë¡œ ë²„íŠ¼ í™œì„±í™”

## ì„±ëŠ¥ ìµœì í™”

### ê°€ìƒí™” (ë§ì€ ë¦¬ë·°ì¼ ë•Œ)
```typescript
import { useVirtualizer } from '@tanstack/react-virtual';

// ë¦¬ë·°ê°€ 50ê°œ ì´ìƒì¼ ë•Œ ê°€ìƒí™” ì ìš©
const parentRef = useRef<HTMLDivElement>(null);
const virtualizer = useVirtualizer({
  count: reviews.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 200,
  overscan: 5,
});
```

### ë©”ëª¨ì´ì œì´ì…˜
```typescript
const ReviewItem = React.memo(({ review }: { review: Review }) => {
  // ...
});

const StarRating = React.memo(({ rating, onSelect }: StarRatingProps) => {
  // ...
});
```
