# Performance Card - ê¸°ëŠ¥ ëª…ì„¸

## í˜„ì¬ êµ¬í˜„ ìƒíƒœ âœ…

### Props ì¸í„°í˜ì´ìŠ¤
```typescript
interface Performance {
  id: string;
  title: string;
  category: string;
  venue: string;
  district: string;
  date: string;
  time: string;
  price: string;
  image: string;
  rating: number;
  reviewCount: number;
  description: string;
  organizer: string;
}

interface PerformanceCardProps {
  performance: Performance;
  onViewDetails: (performance: Performance) => void;
  onDateProposal?: (performance: Performance) => void;
}
```

## ì£¼ìš” ê¸°ëŠ¥

### 1. ê³µì—° ì •ë³´ í‘œì‹œ âœ…
- ì œëª©, ì¹´í…Œê³ ë¦¬, ì¥ì†Œ, ë‚ ì§œ, ì‹œê°„
- í‰ì  ë° ë¦¬ë·° ìˆ˜
- ê°€ê²© ì •ë³´
- ì´ë¯¸ì§€ (fallback í¬í•¨)

**êµ¬í˜„ ìœ„ì¹˜:** `PerformanceCard.tsx` ë¼ì¸ 30-91

### 2. ì´ë²¤íŠ¸ ì²˜ë¦¬ âœ…
#### ìƒì„¸ì •ë³´ ë²„íŠ¼
```typescript
onClick={() => onViewDetails(performance)}
```
- ìƒì„¸ í˜ì´ì§€ ëª¨ë‹¬ ì—´ê¸°
- Performance ê°ì²´ ì „ë‹¬

#### ë°ì´íŠ¸ ì‹ ì²­ ë²„íŠ¼ (optional)
```typescript
onClick={() => onDateProposal(performance)}
```
- ë§¤ì¹­ ì‹ ì²­ í”Œë¡œìš° ì‹œì‘
- onDateProposal propì´ ìˆì„ ë•Œë§Œ í‘œì‹œ

### 3. ì´ë¯¸ì§€ ì²˜ë¦¬ âœ…
- `ImageWithFallback` ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©
- ë¡œë“œ ì‹¤íŒ¨ ì‹œ fallback ì´ë¯¸ì§€
- Lazy loading ì§€ì›

## ê°œì„ ì´ í•„ìš”í•œ ê¸°ëŠ¥ ğŸ”§

### 1. ì¢‹ì•„ìš” ê¸°ëŠ¥ â­
**í˜„ì¬:** ë¯¸êµ¬í˜„  
**í•„ìš”í•œ ê¸°ëŠ¥:**
```typescript
// ì¶”ê°€ Props
interface PerformanceCardProps {
  // ... ê¸°ì¡´ props
  isLiked?: boolean;
  onToggleLike?: (performanceId: string) => void;
}

// êµ¬í˜„ ì˜ˆì‹œ
const handleToggleLike = (e: React.MouseEvent) => {
  e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
  onToggleLike?.(performance.id);
};
```

**Supabase ì—°ë™:**
```typescript
// commons/api/performances.ts
export async function toggleLike(userId: string, performanceId: string) {
  const { data, error } = await supabase
    .from('likes')
    .upsert({ user_id: userId, performance_id: performanceId });
  
  if (error) throw error;
  return data;
}
```

### 2. ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ğŸ›’
**í˜„ì¬:** ë¯¸êµ¬í˜„  
**í•„ìš”í•œ ê¸°ëŠ¥:**
```typescript
interface PerformanceCardProps {
  // ... ê¸°ì¡´ props
  onAddToCart?: (performance: Performance) => void;
}

// Zustand Store
interface CartStore {
  items: Performance[];
  addItem: (item: Performance) => void;
  removeItem: (id: string) => void;
}
```

### 3. ê³µìœ  ê¸°ëŠ¥ ğŸ“¤
**í˜„ì¬:** ë¯¸êµ¬í˜„  
**í•„ìš”í•œ ê¸°ëŠ¥:**
```typescript
const handleShare = async () => {
  if (navigator.share) {
    await navigator.share({
      title: performance.title,
      text: performance.description,
      url: window.location.href
    });
  } else {
    // Fallback: ë§í¬ ë³µì‚¬
    await navigator.clipboard.writeText(window.location.href);
    toast.success('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
  }
};
```

### 4. ì‹¤ì‹œê°„ í‰ì  ì—…ë°ì´íŠ¸ ğŸ“Š
**í˜„ì¬:** ì •ì  ë°ì´í„°  
**ê°œì„ :**
```typescript
// Supabase Realtime êµ¬ë…
useEffect(() => {
  const channel = supabase
    .channel('performance-ratings')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'reviews',
        filter: `performance_id=eq.${performance.id}`
      },
      (payload) => {
        // í‰ì  ì¬ê³„ì‚°
        refetchRating();
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, [performance.id]);
```

### 5. ì´ë¯¸ì§€ ìµœì í™” ğŸ–¼ï¸
**í˜„ì¬:** ì›ë³¸ ì´ë¯¸ì§€ ë¡œë“œ  
**ê°œì„ :**
```typescript
// Supabase Storage ì´ë¯¸ì§€ ë³€í™˜
const getOptimizedImage = (url: string, size: 'small' | 'medium' | 'large') => {
  const sizes = {
    small: 'w=300&h=200',
    medium: 'w=600&h=400',
    large: 'w=1200&h=800'
  };
  
  return `${url}?${sizes[size]}&format=webp`;
};

// ì‚¬ìš©
<img src={getOptimizedImage(performance.image, 'medium')} />
```

## ìƒíƒœ ê´€ë¦¬

### í˜„ì¬ ìƒíƒœ
- ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì—ì„œ ëª¨ë“  ìƒíƒœ ê´€ë¦¬
- Props drilling ë°œìƒ ê°€ëŠ¥ì„±

### ê°œì„  ë°©ì•ˆ
```typescript
// hooks/usePerformanceCard.ts
export function usePerformanceCard(performanceId: string) {
  const [isLiked, setIsLiked] = useState(false);
  const [inCart, setInCart] = useState(false);
  
  const toggleLike = async () => {
    // Supabase ì—°ë™
    const { error } = await supabase
      .from('likes')
      .upsert({ performance_id: performanceId });
    
    if (!error) setIsLiked(!isLiked);
  };
  
  return {
    isLiked,
    inCart,
    toggleLike,
    addToCart,
  };
}
```

## ì—ëŸ¬ ì²˜ë¦¬

### í˜„ì¬
- ê¸°ë³¸ ì—ëŸ¬ ì²˜ë¦¬ (ImageWithFallback)

### ê°œì„  í•„ìš”
```typescript
// ì—ëŸ¬ ë°”ìš´ë”ë¦¬
<ErrorBoundary fallback={<PerformanceCardError />}>
  <PerformanceCard {...props} />
</ErrorBoundary>

// ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì²˜ë¦¬
try {
  await toggleLike(performance.id);
} catch (error) {
  if (error.message.includes('network')) {
    toast.error('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”');
  } else if (error.message.includes('auth')) {
    toast.error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
    router.push('/login');
  } else {
    toast.error('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}
```

## ì„±ëŠ¥ ìµœì í™”

### 1. ë©”ëª¨ì´ì œì´ì…˜
```typescript
export const PerformanceCard = React.memo(
  PerformanceCardComponent,
  (prevProps, nextProps) => {
    return prevProps.performance.id === nextProps.performance.id &&
           prevProps.isLiked === nextProps.isLiked;
  }
);
```

### 2. ì´ë¯¸ì§€ Lazy Loading
```typescript
<img
  src={performance.image}
  loading="lazy"
  decoding="async"
/>
```

### 3. ê°€ìƒí™” (Virtual List)
ëª©ë¡ì— ìˆ˜ë°± ê°œì˜ ì¹´ë“œê°€ ìˆì„ ë•Œ:
```typescript
import { useVirtualizer } from '@tanstack/react-virtual';

// ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì—ì„œ
const virtualizer = useVirtualizer({
  count: performances.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 350, // ì¹´ë“œ ë†’ì´
});
```

## í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

### Unit Tests
```typescript
describe('PerformanceCard', () => {
  it('renders performance information correctly', () => {
    render(<PerformanceCard performance={mockPerformance} />);
    expect(screen.getByText(mockPerformance.title)).toBeInTheDocument();
  });
  
  it('calls onViewDetails when button is clicked', () => {
    const handleViewDetails = jest.fn();
    render(
      <PerformanceCard 
        performance={mockPerformance} 
        onViewDetails={handleViewDetails}
      />
    );
    
    fireEvent.click(screen.getByText('ìƒì„¸ì •ë³´'));
    expect(handleViewDetails).toHaveBeenCalledWith(mockPerformance);
  });
  
  it('shows date proposal button when onDateProposal is provided', () => {
    const handleDateProposal = jest.fn();
    render(
      <PerformanceCard 
        performance={mockPerformance}
        onViewDetails={jest.fn()}
        onDateProposal={handleDateProposal}
      />
    );
    
    expect(screen.getByRole('button', { name: /heart/i })).toBeInTheDocument();
  });
});
```

## API ì—°ë™ ê³„íš

### Supabase í…Œì´ë¸” êµ¬ì¡°
```sql
-- performances í…Œì´ë¸”
CREATE TABLE performances (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title TEXT NOT NULL,
  category TEXT NOT NULL,
  venue TEXT NOT NULL,
  district TEXT NOT NULL,
  date DATE NOT NULL,
  time TEXT NOT NULL,
  price TEXT,
  image_url TEXT,
  description TEXT,
  organizer TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ratings í…Œì´ë¸” (í‰ê·  í‰ì  ê³„ì‚°ìš©)
CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  performance_id UUID REFERENCES performances(id),
  user_id UUID REFERENCES users(id),
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  content TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- likes í…Œì´ë¸”
CREATE TABLE likes (
  user_id UUID REFERENCES users(id),
  performance_id UUID REFERENCES performances(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (user_id, performance_id)
);
```

### API í•¨ìˆ˜
```typescript
// commons/api/performances.ts

// ê³µì—° ëª©ë¡ ì¡°íšŒ
export async function fetchPerformances(filters?: PerformanceFilters) {
  let query = supabase
    .from('performances')
    .select('*, reviews(rating)');
  
  if (filters?.category) {
    query = query.eq('category', filters.category);
  }
  
  if (filters?.district) {
    query = query.eq('district', filters.district);
  }
  
  const { data, error } = await query;
  
  if (error) throw error;
  
  // í‰ì  ê³„ì‚°
  return data.map(perf => ({
    ...perf,
    rating: calculateAvgRating(perf.reviews),
    reviewCount: perf.reviews.length
  }));
}

// ì¢‹ì•„ìš” í† ê¸€
export async function toggleLike(userId: string, performanceId: string) {
  const { data: existing } = await supabase
    .from('likes')
    .select()
    .eq('user_id', userId)
    .eq('performance_id', performanceId)
    .single();
  
  if (existing) {
    // ì´ë¯¸ ì¢‹ì•„ìš”í•œ ê²½ìš° ì‚­ì œ
    return await supabase
      .from('likes')
      .delete()
      .eq('user_id', userId)
      .eq('performance_id', performanceId);
  } else {
    // ì¢‹ì•„ìš” ì¶”ê°€
    return await supabase
      .from('likes')
      .insert({ user_id: userId, performance_id: performanceId });
  }
}
```

## ë‹¤ìŒ ë‹¨ê³„ ë¡œë“œë§µ

### Phase 1 (1ì£¼)
- [ ] ì¢‹ì•„ìš” ê¸°ëŠ¥ êµ¬í˜„
- [ ] API ì—°ë™ (Supabase)
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”

### Phase 2 (2ì£¼)
- [ ] ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥
- [ ] ê³µìœ  ê¸°ëŠ¥
- [ ] ì„±ëŠ¥ ìµœì í™” (ë©”ëª¨ì´ì œì´ì…˜)

### Phase 3 (3ì£¼)
- [ ] ì‹¤ì‹œê°„ í‰ì  ì—…ë°ì´íŠ¸
- [ ] ì´ë¯¸ì§€ ìµœì í™”
- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
